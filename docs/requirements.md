# 社員総会投票システム - 要件定義書

## 要件定義の作成原則
- **「あったらいいな」は絶対に作らない**
- **拡張可能性のための余分な要素は一切追加しない**
- **将来の「もしかして」のための準備は禁止**
- **今、ここで必要な最小限の要素のみ**

---

## 1. プロジェクト概要

### 1.1 成果目標
社員総会（年1回）で150名がスマホから各部署の発表を3つの評価項目で10段階評価し、総合得点で競う。リアルタイムで結果が可視化され、部署別・項目別の評価結果が記録として保存される評価システム

### 1.2 成功指標

#### 定量的指標
| # | 指標 | 目標値 |
|---|------|--------|
| 1 | 投票完了までの時間 | 2分以内（全員投票完了） |
| 2 | 投票参加率 | 90%以上（135名/150名以上） |
| 3 | システムエラー発生率 | 0% |
| 4 | 同時接続対応 | 150名同時アクセス |
| 5 | 結果データ保存 | 過去の投票結果を保存・閲覧可能 |

#### 定性的指標
| # | 指標 |
|---|------|
| 1 | 社員が迷わず投票できる（操作説明不要） |
| 2 | 結果表示で会場が盛り上がる |
| 3 | 運営担当の負担が最小限（集計作業ゼロ） |
| 4 | 来年以降も同じシステムを再利用できる |

---

## 2. ペルソナ・ユーザーストーリー

### 2.1 ペルソナ

#### ペルソナA: 投票する社員
| 項目 | 内容 |
|------|------|
| 属性 | 20代〜50代、全社員 |
| ITリテラシー | 高〜低（混在） |
| 状況 | 社員総会会場でスマホを持っている |

#### ペルソナB: 運営担当
| 項目 | 内容 |
|------|------|
| 属性 | 事務局スタッフ |
| 役割 | 投票の案内、スクリーン投影 |
| 要望 | 操作を最小限にしたい |

### 2.2 現状の痛み

#### 定量的損失
- 紙投票の場合: 25〜35分（配布・記入・回収・集計）
- 集計ミス発生率: 5〜10%

#### 定性的フラストレーション
1. 集計待ち時間で場がダレる
2. 結果発表までのワクワク感が薄れる
3. 挙手方式だと同調圧力で本音投票できない

### 2.3 競合分析

| サービス | 良い点 | 悪い点 | 50人総会での問題 |
|---------|-------|--------|-----------------|
| Mentimeter | 美しいUI | 無料は月50人上限 | 1回で上限到達 |
| Slido | Teams連携 | 無料は投票3回まで | 5部署で制限超過 |
| Googleフォーム | 無料・無制限 | リアルタイム表示なし | 自作が必要 |
| Microsoft Forms | プレゼン機能あり | 無料は200件まで | 制限に引っかかる |

なぜ自作が良いか: 投票回数・参加者数の制限なし、完全カスタマイズ可能、ランニングコスト最小

### 2.4 ユーザーストーリー

1. 「**社員**として、直感的に投票するために、**部署をカード形式で表示し、タップで選択できる画面**が欲しい」
2. 「**社員**として、選択を確認するために、**選んだカードにチェックマークが表示される視覚的フィードバック**が欲しい」
3. 「**運営担当**として、投票進捗を把握するために、**投票数をリアルタイム表示する機能**が欲しい」
4. 「**発表者・経営層**として、結果発表を盛り上げるために、**1位をハイライト表示する機能**が欲しい」

### 2.5 期待効果

| 項目 | 現在（紙方式） | 理想（システム） | 改善率 |
|------|--------------|-----------------|--------|
| 所要時間 | 15分 | 2分 | 85%短縮 |
| 集計ミス | 5〜10% | 0% | 100%削減 |
| 運営負担 | 配布・回収・集計 | URL共有のみ | 大幅削減 |

---

## 3. システム全体像

### 3.1 主要機能一覧

| 機能 | 概要 |
|------|------|
| 評価機能 | 社員がスマホから全部署を3項目×10段階で評価 |
| リアルタイム集計 | 評価結果を即時集計・総合得点を表示 |
| 項目別集計 | 部署ごとの評価項目別の平均点を集計・表示 |
| 二重評価防止 | 同一端末からの再評価をブロック |
| 結果保存 | 評価結果をDBに永続保存 |

### 3.2 ユーザーロールと権限

| ロール | アクセス可能な機能 |
|--------|-------------------|
| 社員（ゲスト） | 投票ページで投票 |
| 運営担当 | 結果表示ページを投影 |
| 管理者 | DB直接編集で部署データ管理 |

### 3.3 認証・認可要件

| 項目 | 内容 |
|------|------|
| 認証方式 | **なし**（認証不要） |
| 二重投票防止 | FingerprintJS + localStorage |
| 管理機能 | DB直接編集（管理画面なし） |

---

## 4. ページ詳細仕様

### 4.1 P-001: 評価ページ

#### 目的
社員がスマホから全部署の発表を3つの評価項目で10段階評価する

#### 解決するユーザーストーリー
- 「社員として、各部署を公平に評価するために、全部署を同じ基準で評価できる画面が欲しい」
- 「社員として、評価を確認するために、選択した点数が視覚的にわかるフィードバックが欲しい」
- 「運営担当として、詳細な評価データを分析するために、複数の評価項目で点数を収集したい」

#### 主要機能
- 部署一覧を表示（全5部署を順番に評価）
- **評価項目をDBから動的取得**（ハードコードしない）
- 各部署に対して3項目×10段階で評価
- 「次の部署へ」ボタンで次の部署の評価へ
- 全部署評価完了後、「送信」ボタンで評価送信
- 評価完了画面の表示
- 二重評価防止

#### 必要な操作

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 部署一覧取得 | なし | 部署ID、部署名、画像URL |
| 取得 | 評価項目一覧取得 | なし | 項目ID、項目名、表示順 |
| 作成 | 評価送信 | 部署ID×項目ID×点数の配列、フィンガープリント | 評価完了メッセージ |

#### 処理フロー
1. ユーザーがURLにアクセス
2. 二重評価チェック（localStorage + サーバー照合）
3. 部署一覧と評価項目をDBから取得
4. 1番目の部署の評価画面を表示
5. ユーザーが3項目を10段階で評価
6. 「次の部署へ」ボタンで次の部署へ
7. 手順5〜6を全部署分繰り返す
8. 全部署評価完了後、確認画面を表示
9. 「送信」ボタンで評価データを一括送信
10. 評価完了画面を表示
11. localStorageに評価済みフラグを保存

#### データ構造（概念）
```yaml
Evaluation:
  識別子: 自動生成ID
  基本情報:
    - department_id（必須）: 評価対象部署ID
    - criteria_id（必須）: 評価項目ID
    - score（必須）: 点数（1〜10）
    - fingerprint（必須）: 端末識別子
    - event_year: 評価年度
  メタ情報:
    - created_at: 評価日時
```

---

### 4.2 P-002: 結果表示ページ

#### 目的
リアルタイム評価結果（総合得点）をスクリーンに投影する

#### 解決するユーザーストーリー
- 「運営担当として、評価進捗を把握するために、評価人数をリアルタイム表示する機能が欲しい」
- 「発表者・経営層として、結果発表を盛り上げるために、1位をハイライト表示する機能が欲しい」

#### 主要機能
- 評価結果（総合得点）を棒グラフで表示
- 評価人数をリアルタイム表示（87/150名）
- 1位をハイライト表示
- 自動更新（ポーリング）
- **各部署をクリックで項目別詳細ページに遷移**

#### 必要な操作

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 評価結果取得 | なし | 部署別総合得点、評価人数 |

#### 処理フロー
1. 運営担当がPCで結果表示ページを開く
2. プロジェクターでスクリーンに投影
3. 5秒間隔で評価結果を自動取得
4. 棒グラフと評価人数を更新表示
5. 1位の部署をハイライト表示
6. **部署をクリックすると項目別詳細ページ（P-003）に遷移**

#### データ構造（概念）
```yaml
EvaluationResult:
  基本情報:
    - department_id: 部署ID
    - department_name: 部署名
    - total_score: 総合得点（全評価者の3項目合計点の合計）
  集計情報:
    - total_evaluators: 評価人数
    - target_evaluators: 対象者数（150名）
```

---

### 4.3 P-003: 項目別詳細ページ

#### 目的
特定の部署に対する評価項目別の詳細結果を表示する

#### 解決するユーザーストーリー
- 「運営担当として、各部署の強み・弱みを分析するために、項目別の点数を確認したい」
- 「発表者・経営層として、自部署の評価を把握するために、どの項目で高評価だったかを知りたい」

#### 主要機能
- 選択した部署の項目別得点を表示
- 項目ごとの合計点・平均点を棒グラフまたはリストで表示
- 結果表示ページに戻るボタン
- 自動更新（ポーリング）

#### 必要な操作

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 項目別評価結果取得 | 部署ID | 項目別得点、部署名 |

#### 処理フロー
1. 結果表示ページで部署をクリック
2. `/results/:departmentId` に遷移
3. 該当部署の項目別評価結果を取得
4. 項目ごとの得点をグラフ/リストで表示
5. 5秒間隔で自動更新
6. 「戻る」ボタンで結果表示ページに戻る

#### データ構造（概念）
```yaml
CriteriaResult:
  基本情報:
    - department_id: 部署ID
    - department_name: 部署名
    - total_score: 総合得点
  項目別集計:
    - criteria_id: 評価項目ID
    - criteria_name: 評価項目名
    - total_points: 合計点
    - average_score: 平均点
    - evaluator_count: 評価人数
```

---

## 5. データ設計概要

### 5.1 主要エンティティ

```yaml
Department:
  概要: 評価対象の部署
  主要属性:
    - id: 部署ID（主キー）
    - name: 部署名
    - image_url: 部署画像URL（Cloudinary）
    - display_order: 表示順
  メタ情報:
    - created_at: 作成日時
    - updated_at: 更新日時

EvaluationCriteria:
  概要: 評価項目マスタ（DBで管理、後から変更可能）
  主要属性:
    - id: 評価項目ID（主キー）
    - name: 評価項目名
    - display_order: 表示順
    - is_active: 有効フラグ
  メタ情報:
    - created_at: 作成日時
    - updated_at: 更新日時

Evaluation:
  概要: 評価データ（1人×1部署×1項目で1レコード）
  主要属性:
    - id: 評価ID（主キー）
    - department_id: 評価対象部署ID（外部キー）
    - criteria_id: 評価項目ID（外部キー）
    - score: 点数（1〜10）
    - fingerprint: 端末識別子
    - event_year: 評価年度
  メタ情報:
    - created_at: 評価日時
  関連:
    - Department（多対1）
    - EvaluationCriteria（多対1）

EventConfig:
  概要: イベント設定
  主要属性:
    - id: 設定ID
    - year: 年度
    - target_evaluators: 対象者数（150）
    - is_active: 有効フラグ
```

### 5.2 エンティティ関係図

```
Department ──────────┬── Evaluation（1対多）
                     │
EvaluationCriteria ──┘

EventConfig（独立）
```

### 5.3 バリデーションルール

```yaml
department_id:
  - ルール: 存在する部署IDであること
  - 理由: 不正な評価を防止

criteria_id:
  - ルール: 存在する有効な評価項目IDであること
  - 理由: 不正な評価を防止

score:
  - ルール: 1〜10の整数であること
  - 理由: 10段階評価の範囲制限

fingerprint:
  - ルール: 同一fingerprint + event_yearの組み合わせは各部署×各項目で1件のみ
  - 理由: 二重評価防止

event_year:
  - ルール: 有効なイベント年度であること
  - 理由: 過去データとの分離
```

---

## 6. 制約事項

### 技術的制約

| 制約項目 | 詳細 |
|---------|------|
| Vercel関数タイムアウト | 10秒（SSE不可、ポーリングで代替） |
| 同時接続数 | 150名（無料枠で対応可能） |
| 二重投票防止精度 | 90%以上（別ブラウザで回避可能だが社内イベントでは十分） |

### 6.1 セキュリティ要件

#### 基本方針
認証なしの公開ページのため、最小限のセキュリティ対策を実施

#### プロジェクト固有の必須要件

**認証機能がない場合（本プロジェクト）**:
- ✅ 入力値のサニタイゼーション
- ✅ SQLインジェクション対策（Prisma ORM使用）
- ✅ HTTPS強制（本番環境）
- ✅ 二重投票防止（FingerprintJS）

**その他の一般要件**:
- ✅ セキュリティヘッダー設定（本番環境）
- ✅ エラーメッセージでの情報漏洩防止

---

### 運用要件：可用性とヘルスチェック

**ヘルスチェックエンドポイント**:
- エンドポイント: `/api/health`
- 目的: サービス稼働確認
- 要件: データベース接続確認、5秒以内の応答

---

## 7. 技術スタック

### フロントエンド
| 項目 | 技術 |
|------|------|
| フレームワーク | React 18 |
| 言語 | TypeScript 5 |
| UIライブラリ | MUI v6 |
| ルーティング | React Router v6 |
| ビルドツール | Vite 5 |

### バックエンド
| 項目 | 技術 |
|------|------|
| ランタイム | Node.js |
| フレームワーク | Vercel Functions（Serverless） |
| リアルタイム | ポーリング（5秒間隔） |

### データベース
| 項目 | 技術 |
|------|------|
| DB | Neon（PostgreSQL） |
| ORM | Prisma |

### インフラ
| 項目 | 技術 |
|------|------|
| ホスティング | Vercel |
| 画像ストレージ | Cloudinary |

---

## 8. 必要な外部サービス・アカウント

### 必須サービス

| サービス名 | 用途 | 取得先 | 料金 |
|-----------|------|--------|------|
| Vercel | ホスティング | https://vercel.com | 無料 |
| Neon | PostgreSQLデータベース | https://neon.tech | 無料 |
| Cloudinary | 画像ストレージ | https://cloudinary.com | 無料 |

### npmパッケージ（アカウント不要）

| パッケージ | 用途 |
|-----------|------|
| @fingerprintjs/fingerprintjs | 二重投票防止 |
| @prisma/client | ORM |
| recharts | グラフ描画 |

---

## 9. 初期データ

### 部署データ（5部署）

| # | 部署名 | 備考 |
|---|--------|------|
| 1 | コンシューマーカンパニー | 画像は別途用意 |
| 2 | コーポレートセールスカンパニー | 画像は別途用意 |
| 3 | SSDカンパニー | 画像は別途用意 |
| 4 | BBC | 画像は別途用意 |
| 5 | Unneon | 画像は別途用意 |

※ 部署名・画像はDB直接編集で変更可能

### 評価項目データ（3件）

| # | 評価項目名 | 備考 |
|---|-----------|------|
| 1 | 文化・制度の魅力度 | 1〜10点で評価 |
| 2 | 未来への期待値（ワクワクしたか） | 1〜10点で評価 |
| 3 | そのカンパニーに所属しているヒトの魅力を感じれたか | 1〜10点で評価 |

※ 評価項目名・表示順・有効フラグはDB直接編集で変更可能（ハードコードしない）

---

## 10. 今後の拡張予定

**原則**: 拡張予定があっても、必要最小限の実装のみを行う

- 「あったらいいな」は実装しない
- 拡張可能性のための余分な要素は追加しない
- 将来の「もしかして」のための準備は禁止
- 今、ここで必要な最小限の要素のみを実装

拡張が必要になった時点で、拡張フェーズで追加実装を行います。

（拡張候補があれば以下に記載、ただし実装はしない）
- 管理画面（部署・画像の編集UI）
- 過去結果閲覧画面
- 複数投票対応（1人複数票）
